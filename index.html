<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CrossCraft — Arte, Skins y Nación de Factos</title>

  <!-- Creative, evocative SEO description -->
  <meta name="description" content="CrossCraft — el refugio morado donde las skins respiran. Previsualiza, prueba y descarga skins únicas; descubre curiosidades escondidas y conéctate a la comunidad de Nación de Factos. Diseño liquid-glass, animaciones suaves y soporte 3D opcional." />
  <meta name="keywords" content="CrossCraft, skins minecraft, servidor minecraft, nación de factos, skins descargables, discord minecraft, liquid glass, morado neon" />
  <link rel="canonical" href="https://crosscraft.example.com/" />

  <!-- Open Graph -->
  <meta property="og:title" content="CrossCraft — Arte, Skins y Nación de Factos" />
  <meta property="og:description" content="El refugio morado de las skins: explora, previsualiza y descarga. Conéctate a Nación de Factos y únete a nuestra comunidad." />
  <meta property="og:image" content="https://static.vecteezy.com/system/resources/previews/002/948/785/original/pixel-minecraft-style-land-background-vector.jpg" />
  <meta property="og:type" content="website" />

  <!-- Favicon (user provided) -->
  <link rel="icon" href="https://static.vecteezy.com/system/resources/previews/002/948/785/original/pixel-minecraft-style-land-background-vector.jpg" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!--
    CrossCraft — single file index.html
    - Liquid glass + morado neon aesthetic
    - Skins search via Mojang API + Crafatar (fallbacks)
    - Server status via mcsrvstat.us (with timeouts & fallbacks)
    - Discord invite counts via Discord invite API (with CORS fallback)
    - 3D viewer (skinview3d) loaded dynamically if available
    - Client caching via sessionStorage (60s)
    - Notes about SFTP: browsers cannot talk SFTP. The provided SFTP (sftp://node-va5.holy.gg:2022) is useful to upload assets to your host. See comments below for usage.
  -->

  <style>
    /* ===== Reset & Theme ===== */
    :root{
      --bg:#06060b;
      --glass-1: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --muted:#b9c0c9;
      --purple-1:#9b4dff;
      --purple-2:#b267ff;
      --accent: linear-gradient(135deg,var(--purple-1),var(--purple-2));
      --radius:18px;
      --soft-shadow: 0 12px 40px rgba(142,86,255,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:
        radial-gradient(800px 320px at 10% 8%, rgba(155,77,255,0.06), transparent 6%),
        radial-gradient(600px 260px at 92% 82%, rgba(178,103,255,0.04), transparent 6%),
        var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding-bottom:60px;
    }

    /* ===== Utilities ===== */
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:var(--soft-shadow);
      backdrop-filter: blur(10px) saturate(140%);
    }
    .section-title{display:flex;justify-content:space-between;align-items:center}
    .title {color:var(--purple-2);font-weight:800;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}

    /* ===== Header (glass, sticky) ===== */
    header.nav{
      position:sticky;top:0;z-index:120;background:linear-gradient(180deg, rgba(6,6,10,0.6), rgba(6,6,10,0.35));
      padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(8px)
    }
    .nav-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:52px;height:52px;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,0.04)}
    .brand .logo img{width:100%;height:100%;object-fit:cover}
    .brand .name{font-weight:800;color:var(--purple-2);letter-spacing:0.6px}
    nav.links{display:flex;gap:14px}
    nav.links a{color:rgba(255,255,255,0.92);text-decoration:none;padding:8px 10px;border-radius:10px;font-weight:600}
    nav.links a:hover{background:linear-gradient(90deg, rgba(155,77,255,0.06), rgba(178,103,255,0.04));color:var(--purple-2)}

    /* ===== Hero ===== */
    .hero{padding:72px 20px 40px;text-align:center}
    .hero h1{font-size:44px;margin:0;line-height:1.05;font-weight:800;color:transparent;background:var(--accent);-webkit-background-clip:text}
    .hero p{color:var(--muted);margin-top:12px;font-size:16px;max-width:900px;margin-left:auto;margin-right:auto}

    /* ===== Controls ===== */
    .controls{display:flex;gap:12px;align-items:center}
    .btn{
      border:0;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;
      background:linear-gradient(90deg,var(--purple-1),var(--purple-2));color:white;box-shadow:0 8px 30px rgba(178,103,255,0.14);
      transition:transform .18s ease, box-shadow .18s;
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--purple-2)}
    .btn:active{transform:translateY(1px)}
    .btn:hover{transform:translateY(-4px)}

    /* ===== Skins grid ===== */
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:14px}
    .search{
      display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      min-width:280px;
    }
    .search input{background:transparent;border:0;color:#fff;padding:8px;outline:none;width:100%}
    .skins-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-top:18px}
    .skin-card{padding:14px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;transition:transform .22s, box-shadow .22s}
    .skin-card:hover{transform:translateY(-10px);box-shadow:0 20px 50px rgba(155,77,255,0.08);border-color:rgba(155,77,255,0.08)}
    .skin-thumb{width:160px;height:160px;border-radius:12px;background:#0b0620;object-fit:cover}
    .skin-name{margin-top:10px;font-weight:700}
    .skin-meta{font-size:13px;color:var(--muted);margin-top:6px}

    .card-actions{display:flex;gap:8px;width:100%;margin-top:12px}
    .card-actions button{flex:1;padding:9px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .card-actions .primary{background:var(--purple-2);color:white}
    .card-actions .muted{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--purple-2)}

    /* ===== Modal (preview & 3D) ===== */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(1,1,1,0.6), rgba(1,1,1,0.8));z-index:200}
    .modal.open{display:flex}
    .modal-panel{width:min(980px,94%);display:flex;gap:18px;padding:20px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    .modal img{width:360px;height:360px;border-radius:12px;object-fit:cover}
    .modal .info h3{color:var(--purple-2);margin-top:0}

    /* server & discord column */
    .sidebar{display:flex;flex-direction:column;gap:16px}
    .server-box{padding:14px;border-radius:12px;background:linear-gradient(180deg,#0d0d10,#08080a);border:1px solid rgba(255,255,255,0.03)}
    .server-row{display:flex;justify-content:space-between;padding:10px 0;border-top:1px dashed rgba(255,255,255,0.02)}
    .server-row:first-child{border-top:0}
    .discord-box{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,#111216,#0a0a0c);border:1px solid rgba(255,255,255,0.03)}

    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(180deg,#22102b,#17051a);padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);display:none;z-index:999}

    /* credits */
    footer{padding:30px 20px;text-align:center;border-top:1px solid rgba(255,255,255,0.02);margin-top:40px}
    .credits{display:flex;gap:14px;align-items:center;justify-content:center}
    .credits img{width:110px;height:110px;border-radius:18px;border:3px solid rgba(155,77,255,0.18)}
    .badges{display:flex;gap:10px;margin-top:8px}
    .badge{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(155,77,255,0.12), rgba(178,103,255,0.08));color:var(--muted);font-weight:700;font-size:13px}

    /* responsive tweaks */
    @media(max-width:960px){
      .modal img{width:260px;height:260px}
      .skins-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
      .hero h1{font-size:32px}
      .nav-inner{padding:0 8px}
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="nav" role="banner" aria-label="Main navigation">
    <div class="nav-inner container">
      <div class="brand" aria-hidden="false">
        <div class="logo" title="CrossCraft">
          <!-- USER LOGO (pixel art) -->
          <img src="https://static.vecteezy.com/system/resources/previews/002/948/785/original/pixel-minecraft-style-land-background-vector.jpg" alt="CrossCraft logo">
        </div>
        <div>
          <div class="name">CROSSCRAFT</div>
          <div style="color:var(--muted);font-size:12px">Skins · Curiosidades · Nación de Factos</div>
        </div>
      </div>

      <nav class="links" aria-label="Main links">
        <a href="#skins">Skins</a>
        <a href="#curiosidades">Curiosidades</a>
        <a href="#server">Servidor</a>
        <a href="#discord">Discord</a>
        <a href="#credits">Créditos</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero" role="region" aria-labelledby="hero-title">
    <div class="container">
      <h1 id="hero-title">CrossCraft — el refugio morado donde las skins respiran</h1>
      <p style="margin-top:12px" class="subtitle">Previsualiza, prueba y descarga skins; descubre curiosidades y conéctate a Nación de Factos. Diseño liquid-glass, animaciones suaves y opción 3D para rotar las skins.</p>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container" role="main">

    <!-- SKINS SECTION -->
    <section id="skins" class="glass" aria-labelledby="skins-title">
      <div class="section-title">
        <div>
          <div class="title" id="skins-title">Skins Populares</div>
          <div class="subtitle">Busca por nombre o refresca para ver nuevas selecciones.</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="search" role="search" aria-label="Buscar skins">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.9;margin-left:6px"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input id="skinQuery" placeholder="Buscar skin (ej: Dream) — Enter para validar con Mojang" aria-label="Buscar skin por nombre">
          </div>
          <button id="btnRefresh" class="btn" title="Refrescar skins">Refrescar</button>
          <button id="btnSeed" class="btn ghost" title="Mostrar sugerencias">Sugerencias</button>
        </div>
      </div>

      <div id="skinsGrid" class="skins-grid" aria-live="polite" aria-busy="false">
        <!-- Cards populated by JS -->
      </div>
    </section>

    <!-- CURIOSITIES + SERVER/DISCORD -->
    <section style="margin-top:22px;display:grid;grid-template-columns:1fr 360px;gap:18px">
      <div class="glass" id="curiosities" aria-labelledby="curio-title">
        <div class="section-title">
          <div>
            <div class="title" id="curio-title">Datos Curiosos</div>
            <div class="subtitle">Pequeñas maravillas y secretos del mundo Minecraft.</div>
          </div>
          <div><button id="btnMoreFact" class="btn ghost">Mostrar otro</button></div>
        </div>

        <div id="factBox" style="margin-top:12px;font-size:18px;color:#eaeef6"></div>
      </div>

      <aside>
        <div class="server-box glass" id="serverBox" role="region" aria-labelledby="server-title">
          <div class="server-title" id="server-title">NACIÓN DE FACTOS — Status</div>
          <div style="margin-top:8px;font-size:14px;color:var(--muted)">Java: <strong>51.81.49.204:26347</strong></div>
          <div style="margin-top:12px">
            <div class="server-row"><div class="k">Estado</div><div class="v" id="sv_status">—</div></div>
            <div class="server-row"><div class="k">Jugadores</div><div class="v" id="sv_players">—</div></div>
            <div class="server-row"><div class="k">Ping</div><div class="v" id="sv_ping">—</div></div>
            <div class="server-row"><div class="k">Versión</div><div class="v" id="sv_version">—</div></div>
            <div class="server-row"><div class="k">MOTD</div><div class="v" id="sv_motd" style="font-weight:600;color:var(--muted)">—</div></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" onclick="copyToClipboard('51.81.49.204:26347')">Copiar Java</button>
            <button class="btn ghost" onclick="copyToClipboard('va5.holy.gg:26347')">Copiar Bedrock</button>
          </div>
          <div style="margin-top:10px"><button class="btn ghost" id="refreshServer">Refrescar</button></div>
          <div style="margin-top:10px;color:var(--muted);font-size:12px">Nota: algunos endpoints públicos pueden bloquearse por CORS cuando se prueba localmente. Si ves "No disponible", inténtalo desde un hosting real.</div>
        </div>

        <div style="height:14px"></div>

        <div class="discord-box glass" id="discordBox" role="region" aria-label="Discord widget">
          <img src="https://cdn.discordapp.com/attachments/1374967908538519635/1439676343179677880/a_e72faee3796738ef6facb1c45b3bc1ba.png?ex=691b6294&is=691a1114&hm=dc3459f6fa9ffd2c996c89d08cc903046d07aa308bac11f5d3232f988fe08086" alt="Discord logo">
          <div>
            <div style="font-weight:800">Fuck se viene la decadencia</div>
            <div class="subtitle" id="discordCounts">Cargando miembros...</div>
            <div style="margin-top:10px"><a class="btn" target="_blank" rel="noreferrer" href="https://discord.gg/4qU4DsVCsF">Unirse</a></div>
          </div>
        </div>
      </aside>
    </section>

  </main>

  <!-- MODAL PREVIEW (2D + Optional 3D viewer) -->
  <div id="previewModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-panel">
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
        <img id="previewImg" src="" alt="Preview skin">
        <div style="display:flex;gap:8px">
          <button id="downloadNow" class="btn">Descargar</button>
          <button id="toggle3D" class="btn ghost">Activar 3D</button>
          <button id="closeModal" class="btn ghost">Cerrar</button>
        </div>
      </div>
      <div class="info" style="flex:1">
        <h3 id="previewName" style="margin:0;color:var(--purple-2)"></h3>
        <p id="previewNote" style="color:var(--muted);margin-top:8px">Puedes descargar o activar la vista 3D (si el navegador lo permite).</p>
        <div id="viewerContainer" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Credits -->
  <footer id="credits">
    <div class="credits">
      <img src="https://cdn.discordapp.com/avatars/957101336976060467/60b4c474aa77b2cb07167984d3fc9425.webp?size=2048" alt="SoyMr mroks">
      <div style="text-align:left">
        <div style="font-size:20px;color:var(--purple-2);font-weight:800">SoyMr mroks</div>
        <div style="color:var(--muted);margin-top:6px">Creador y alma detrás de CrossCraft, NACIÓN DE FACTOS y la comunidad de Discord.</div>
        <div class="badges" aria-hidden="false">
          <div class="badge">Propietario</div>
          <div class="badge">Admin</div>
          <div class="badge">Developer</div>
        </div>
      </div>
    </div>
    <p style="color:var(--muted);margin-top:14px">© <span id="year"></span> CrossCraft — Diseño liquid glass morado.</p>
  </footer>

<script>
/* =================== CONFIG & UTILITIES ===================
   Notes:
   - Mojang API: https://api.mojang.com/users/profiles/minecraft/{username}
     -> returns 204/empty if not found. If found returns {id, name}
   - Crafatar: https://crafatar.com/renders/body/{uuid}?overlay
     - skin: https://crafatar.com/skins/{uuid}
   - mc-heads / minotar can be used as fallback images
   - Server status: https://api.mcsrvstat.us/2/{host:port}
   - Discord invite counts: https://discord.com/api/v9/invites/{code}?with_counts=true
   - skinview3d loaded dynamically from unpkg if user enables 3D
   - sessionStorage caching used (TTL 60s)
   - SFTP note: browsers can't access sftp URLs; use sftp://node-va5.holy.gg:2022 to upload assets to your server from your client/FTP tool.
   ========================================================== */

const CONFIG = {
  SERVER_JAVA: '51.81.49.204:26347',
  SERVER_BEDROCK: 'va5.holy.gg:26347',
  DISCORD_INVITE: '4qU4DsVCsF',
  MOJANG_PROFILE: 'https://api.mojang.com/users/profiles/minecraft/',
  CRAFATAR_BODY: (uuid) => `https://crafatar.com/renders/body/${uuid}?size=512&overlay`,
  CRAFATAR_SKIN: (uuid) => `https://crafatar.com/skins/${uuid}`,
  MCSRVSTAT: (host) => `https://api.mcsrvstat.us/2/${host}`,
  DISCORD_INVITE_API: (code) => `https://discord.com/api/v9/invites/${code}?with_counts=true`,
  SKIN_VIEWER_SRC: 'https://unpkg.com/skinview3d@1.1.7/dist/skinview3d.min.js',
  CACHE_TTL_MS: 60 * 1000
};

/* --- Helper: toast --- */
const toastEl = document.getElementById('toast');
function showToast(msg, t=2200){
  toastEl.textContent = msg;
  toastEl.style.display = 'block';
  toastEl.style.opacity = '1';
  setTimeout(()=> { toastEl.style.opacity='0'; setTimeout(()=> toastEl.style.display='none', 300); }, t);
}

/* --- Helper: fetch with timeout & error handling --- */
async function fetchWithTimeout(url, opts = {}, timeout = 9000){
  const ctrl = new AbortController();
  const id = setTimeout(()=> ctrl.abort(), timeout);
  try{
    const res = await fetch(url, {...opts, signal: ctrl.signal});
    clearTimeout(id);
    return res;
  }catch(e){
    clearTimeout(id);
    throw e;
  }
}

/* ===================== Skins logic ===================== */

/* Local fallback list (60 names) */
const LOCAL_SKINS = [
  'Steve','Alex','Dream','Technoblade','TommyInnit','Notch','BadBoyHalo','GeorgeNotFound','Skeppy','Quackity',
  'Ranboo','PewDiePie','CaptainSparklez','AntVenom','Grian','LDShadowLady','JeromeASF','BajanCanadian','IBxtoycat','Aphmau',
  'W4RM','Purpled','Tubbo','Etho','Aureylian','Logdotzip','CaptainPuffy','Keralis','SamDream','Fallen',
  'Moon','Shadow','Nova','Ruby','Pixel','Knight','DarkSoul','Frost','Viper','Zero',
  'Drako','Lux','Spectre','Ghost','Ender','Miner','Builder','Wizard','Paladin','Skye',
  'Nox','Rift','Shiro','Luna','Echo','Volt','Sora','Zephyr','Nyx','Rune'
];

/* Build initial grid (30 items) */
const skinsGrid = document.getElementById('skinsGrid');
const skinsQueryInput = document.getElementById('skinQuery');

function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

function clearGrid(){ skinsGrid.innerHTML = ''; }

function createSkinCard({displayName, imgSrc, uuid}) {
  const card = document.createElement('div');
  card.className = 'skin-card';
  card.innerHTML = `
    <img class="skin-thumb" src="${imgSrc}" alt="Skin ${displayName}" loading="lazy"/>
    <div class="skin-name">${displayName}</div>
    <div class="skin-meta">Skin popular</div>
    <div class="card-actions">
      <button class="primary" data-action="preview" data-name="${displayName}" data-uuid="${uuid ?? ''}">Previsualizar</button>
      <button class="muted" data-action="download" data-name="${displayName}" data-uuid="${uuid ?? ''}">Descargar</button>
    </div>
  `;
  return card;
}

/* Use Mojang API to resolve username -> uuid */
async function resolveUsernameToUUID(username){
  // sessionStorage caching
  const key = `mc_uuid_${username.toLowerCase()}`;
  try{
    const cached = sessionStorage.getItem(key);
    if(cached){
      const parsed = JSON.parse(cached);
      if(Date.now() - parsed.ts < CONFIG.CACHE_TTL_MS) return parsed.value;
    }
  }catch(e){}
  try{
    const res = await fetchWithTimeout(CONFIG.MOJANG_PROFILE + encodeURIComponent(username), {}, 7000);
    if(res.status === 204 || res.status === 204 || res.status === 204) return null; // not found
    if(!res.ok) return null;
    const json = await res.json();
    const uuid = json && (json.id || json.uuid || null);
    if(uuid){
      try{ sessionStorage.setItem(key, JSON.stringify({ts:Date.now(), value:uuid})); }catch(e){}
      return uuid;
    }
    return null;
  }catch(err){
    return null;
  }
}

/* Build grid function: select 30 from LOCAL_SKINS shuffled or filtered by query */
async function populateSkins(query=''){
  skinsGrid.setAttribute('aria-busy','true');
  clearGrid();
  let list = shuffle(LOCAL_SKINS);
  // if user provided a query and pressed Enter, we try to resolve via Mojang
  if(query && query.trim().length >= 2){
    const q = query.trim();
    // First, try Mojang to get UUID
    showToast('Buscando usuario en Mojang...');
    const uuid = await resolveUsernameToUUID(q);
    if(uuid){
      // If found, show that skin first and include others
      const img = CONFIG.CRAFATAR_BODY(uuid);
      skinsGrid.appendChild(createSkinCard({displayName:q, imgSrc: img, uuid}));
      // fill remainder with shuffled local
      list = list.filter(n => n.toLowerCase() !== q.toLowerCase());
    } else {
      // Not found — we'll use mc-heads/minotar images by name fallback (no uuid)
      // We'll still include the query name as an attempted card (image may be approximate)
      const img = `https://mc-heads.net/body/${encodeURIComponent(q)}`;
      skinsGrid.appendChild(createSkinCard({displayName:q, imgSrc: img, uuid: null}));
      list = list.filter(n => n.toLowerCase() !== q.toLowerCase());
    }
  }

  // Fill to 30 cards
  const needed = 30 - skinsGrid.children.length;
  for(let i=0; i<needed && i<list.length; i++){
    const name = list[i];
    // We can attempt to use session cached UUID quickly else use mc-heads render by name
    const uuidKey = `mc_uuid_${name.toLowerCase()}`;
    let uuid = null;
    try{
      const cached = JSON.parse(sessionStorage.getItem(uuidKey) || 'null');
      if(cached && Date.now() - cached.ts < CONFIG.CACHE_TTL_MS) uuid = cached.value;
    }catch(e){}
    const img = uuid ? CONFIG.CRAFATAR_BODY(uuid) : `https://mc-heads.net/body/${encodeURIComponent(name)}`;
    skinsGrid.appendChild(createSkinCard({displayName:name, imgSrc: img, uuid: uuid ?? null}));
  }

  skinsGrid.setAttribute('aria-busy','false');
}

/* Event delegation for preview & download */
skinsGrid.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button');
  if(!btn) return;
  const action = btn.dataset.action;
  const name = btn.dataset.name;
  const uuid = btn.dataset.uuid || null;
  if(action === 'preview') return openPreview(name, uuid);
  if(action === 'download') return downloadSkin(name, uuid);
});

/* Preview modal & 3D viewer logic */
const modal = document.getElementById('previewModal');
const previewImg = document.getElementById('previewImg');
const previewName = document.getElementById('previewName');
const downloadNowBtn = document.getElementById('downloadNow');
const toggle3DBtn = document.getElementById('toggle3D');
const viewerContainer = document.getElementById('viewerContainer');
let currentSkin = {name:null, uuid:null, image:null};
let skinViewerInstance = null;
let skinviewLoaded = false;

async function openPreview(name, uuid){
  currentSkin.name = name;
  currentSkin.uuid = uuid;
  // determine image
  let imageUrl = uuid ? CONFIG.CRAFATAR_BODY(uuid) : `https://mc-heads.net/body/${encodeURIComponent(name)}`;
  previewImg.src = imageUrl;
  previewName.textContent = name;
  downloadNowBtn.onclick = ()=> downloadSkin(name, uuid);
  // reset viewer
  if(skinViewerInstance){
    try{ skinViewerInstance.destroy(); }catch(e){}
    skinViewerInstance = null;
  }
  viewerContainer.innerHTML = ''; // cleaned if had previous viewer
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  document.addEventListener('keydown', escClose);
  // preload 3D lib lazy on first open if user toggles, otherwise we keep it off
  // note: skinview3d may be blocked by CSP/CORS on some hosts
}

function closePreview(){
  modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
  document.removeEventListener('keydown', escClose);
  if(skinViewerInstance){ try{ skinViewerInstance.destroy(); }catch(e){} skinViewerInstance = null; viewerContainer.innerHTML = ''; }
}
function escClose(e){ if(e.key === 'Escape') closePreview(); }
document.getElementById('closeModal').addEventListener('click', closePreview);
modal.addEventListener('click', (e)=> { if(e.target === modal) closePreview(); });

toggle3DBtn.addEventListener('click', async () => {
  // load skinview3d dynamically if not loaded
  if(!currentSkin.name) return showToast('No hay skin seleccionada');
  if(!skinviewLoaded){
    showToast('Cargando viewer 3D (puede tardar)...');
    try{
      await loadScript(CONFIG.SKIN_VIEWER_SRC);
      skinviewLoaded = true;
    }catch(e){
      skinviewLoaded = false;
      showToast('No se pudo cargar el viewer 3D (bloqueado o no disponible).');
      return;
    }
  }
  // initialize viewer
  try{
    const {SkinViewer} = window;
    if(!SkinViewer) throw new Error('no viewer lib');
    // destroy previous if exists
    if(skinViewerInstance){ try{ skinViewerInstance.destroy(); }catch(e){} skinViewerInstance = null; viewerContainer.innerHTML = ''; }
    const viewerEl = document.createElement('div');
    viewerEl.style.width = '320px';
    viewerEl.style.height = '360px';
    viewerContainer.appendChild(viewerEl);
    const viewer = new SkinViewer({
      width: 320,
      height: 360,
      canvas: viewerEl
    });
    const texture = currentSkin.uuid ? CONFIG.CRAFATAR_SKIN(currentSkin.uuid) : `https://mc-heads.net/body/${encodeURIComponent(currentSkin.name)}`;
    try { viewer.loadSkin(texture); } catch(err){ /* ignore */ }
    skinViewerInstance = viewer;
  }catch(err){
    showToast('Viewer 3D no disponible en este navegador.');
  }
});

/* Helper to dynamically load script */
function loadScript(src){
  return new Promise((resolve, reject) => {
    if(document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.body.appendChild(s);
  });
}

/* Download implementation: fetch -> blob -> save, fallback to external page */
async function downloadSkin(name, uuid){
  showToast('Preparando descarga...');
  // prefer skin file URL if uuid present (Crafatar)
  const url = uuid ? CONFIG.CRAFATAR_SKIN(uuid) : `https://mc-heads.net/body/${encodeURIComponent(name)}`;
  try{
    const res = await fetchWithTimeout(url, {}, 10000);
    if(!res.ok) throw new Error('bad-res');
    const blob = await res.blob();
    const a = document.createElement('a');
    const obj = URL.createObjectURL(blob);
    a.href = obj;
    a.download = `${name}_skin.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(obj);
    showToast('Descarga iniciada');
  }catch(err){
    // fallback: open external download page
    showToast('Descarga directa falló, abriendo página externa...');
    const fallback = uuid ? CONFIG.CRAFATAR_SKIN(uuid) : `https://mc-heads.net/download/${encodeURIComponent(name)}`;
    window.open(fallback, '_blank');
  }
}

/* Search handler: if Enter pressed, attempt Mojang API resolution and rebuild grid */
skinsQueryInput.addEventListener('keydown', async (e) => {
  if(e.key === 'Enter'){
    const q = skinsQueryInput.value.trim();
    if(!q) return;
    // Try to resolve and then populate grid with that query prioritized
    await populateSkins(q);
  }
});

/* Refresh & seed buttons */
document.getElementById('btnRefresh').addEventListener('click', ()=> populateSkins(skinsQueryInput.value.trim()));
document.getElementById('btnSeed').addEventListener('click', ()=> {
  // quick shuffle and show
  skinsQueryInput.value = '';
  populateSkins('');
  showToast('Mostrando sugerencias');
});

/* Initialize on load */
populateSkins('');
/* Optionally build some quick caching of a few UUIDs for common names */
(async function preCacheCommon(){
  const common = ['Dream','Technoblade','TommyInnit','Notch','Steve','Alex'];
  for(const n of common){
    const uuid = await resolveUsernameToUUID(n).catch(()=>null);
    if(uuid) {
      try{ sessionStorage.setItem(`mc_uuid_${n.toLowerCase()}`, JSON.stringify({ts:Date.now(), value:uuid})); }catch(e){}
    }
  }
})();

/* ===================== Facts (25+) ===================== */
const FACTS = [
  "El Creeper nació por accidente al modelar un cerdo con proporciones incorrectas.",
  "El 'Far Lands' era un bug que producía paisajes fractales en mundos antiguos.",
  "Ciertos sonidos de mobs están basados en voces humanas distorsionadas para crear atmósfera.",
  "Las abejas añadieron polinización en 1.15 y cambiaron la agricultura en el juego.",
  "Los pandas muestran distintas personalidades que influyen en su comportamiento.",
  "El Wither fue diseñado para destruir terreno con su explosión masiva.",
  "La música de Minecraft compuesta por C418 es clave para su nostalgia.",
  "Redstone permite crear mecánicas y computadoras dentro del juego.",
  "Los aldeanos usan camas y estaciones de trabajo para cambiar profesiones.",
  "El Nether actúa como ‘atajo’ por su escalado de coordenadas.",
  "En 1.18 la generación de cuevas se renovó para ser más extensa y variada.",
  "Los pistones posibilitaron la construcción de mecanismos y fábricas automáticas.",
  "Herobrine es una leyenda urbana creada por la comunidad y mods.",
  "Las capas de Notch y otras son elementos raros y estéticos.",
  "Los mobs pasivos tienen IA que responde al entorno y ciclos día/noche.",
  "Las estructuras (templos, aldeas, fortalezas) ofrecen desafíos y loot únicos.",
  "Las pociones añaden estrategias con combinaciones de efectos.",
  "Los resource packs permiten cambiar por completo la apariencia del juego.",
  "Las tiendas de intercambio entre aldeanos permiten economías basadas en emeralds.",
  "Los bloques de comandos permiten automatización y minijuegos avanzados.",
  "Los electores de pigmentos y las paletas de biomas afectan la estética del mundo.",
  "En Bedrock algunas físicas (como explosiones) difieren respecto a Java.",
  "Los mapas antiguos tenían biomas y distribución de recursos distinta.",
  "Las semillas legendarias generan mundos con fenómenos únicos y memorables.",
  "Los datapacks permiten modificar reglas sin instalar mods."
];
let lastFact = -1;
function showFact(){
  let idx = Math.floor(Math.random()*FACTS.length);
  if(idx === lastFact) idx = (idx+1) % FACTS.length;
  lastFact = idx;
  const el = document.getElementById('factBox');
  el.animate([{opacity:0.6, transform:'translateY(8px)'},{opacity:1, transform:'translateY(0)'}],{duration:300});
  el.textContent = FACTS[idx];
}
document.getElementById('btnMoreFact').addEventListener('click', showFact);
showFact();

/* ===================== Server status ===================== */
async function loadServerStatus(){
  const svStatus = document.getElementById('sv_status');
  const svPlayers = document.getElementById('sv_players');
  const svPing = document.getElementById('sv_ping');
  const svVersion = document.getElementById('sv_version');
  const svMotd = document.getElementById('sv_motd');

  svStatus.textContent = 'Comprobando...';
  try{
    const url = CONFIG.MCSRVSTAT(CONFIG.SERVER_JAVA);
    // check cache
    const cacheKey = `svstatus_${CONFIG.SERVER_JAVA}`;
    const cached = JSON.parse(sessionStorage.getItem(cacheKey) || 'null');
    if(cached && Date.now() - cached.ts < CONFIG.CACHE_TTL_MS){
      applyServerData(cached.data); return;
    }

    const res = await fetchWithTimeout(url, {}, 9000);
    if(!res.ok) throw new Error('no-ok');
    const j = await res.json();
    sessionStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data:j}));
    applyServerData(j);
  }catch(err){
    svStatus.textContent = 'No disponible (CORS/Offline)';
    svPlayers.textContent = '-';
    svPing.textContent = '-';
    svVersion.textContent = '-';
    svMotd.textContent = 'No disponible';
  }

  function applyServerData(j){
    svStatus.textContent = j.online ? 'En línea' : 'Desconectado';
    svPlayers.textContent = j.players ? `${j.players.online || 0} / ${j.players.max || '?'}` : '-';
    svPing.textContent = j.ping ? `${j.ping} ms` : (j.online ? '—' : '-');
    svVersion.textContent = j.version || '-';
    const motd = j.motd && (j.motd.clean ? j.motd.clean.join(' ') : j.motd.raw) || '-';
    svMotd.textContent = motd;
  }
}
document.getElementById('refreshServer').addEventListener('click', loadServerStatus);
loadServerStatus();
setInterval(loadServerStatus, 30000);

/* ===================== Discord invite counts ===================== */
async function loadDiscordInvite(){
  const target = document.getElementById('discordCounts');
  try{
    const url = CONFIG.DISCORD_INVITE_API(CONFIG.DISCORD_INVITE);
    const cacheKey = `discord_inv_${CONFIG.DISCORD_INVITE}`;
    const cached = JSON.parse(sessionStorage.getItem(cacheKey) || 'null');
    if(cached && Date.now() - cached.ts < CONFIG.CACHE_TTL_MS){
      target.innerHTML = formatDiscordCounts(cached.data); return;
    }

    const res = await fetchWithTimeout(url, {}, 9000);
    if(!res.ok) throw new Error('no-ok');
    const j = await res.json();
    sessionStorage.setItem(cacheKey, JSON.stringify({ts:Date.now(), data:j}));
    target.innerHTML = formatDiscordCounts(j);
  }catch(err){
    target.innerHTML = `Miembros: <strong>—</strong><br>En línea: <strong>—</strong><br><small style="color:var(--muted)">API bloqueada por CORS o no disponible.</small>`;
  }
}
function formatDiscordCounts(j){
  const total = j.approximate_member_count ?? '—';
  const online = j.approximate_presence_count ?? '—';
  return `Miembros: <strong>${total}</strong><br>En línea: <strong>${online}</strong>`;
}
loadDiscordInvite();
setInterval(loadDiscordInvite, 60000);

/* ===================== Small utilities ===================== */
function copyToClipboard(text){
  if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(()=> showToast('Copiado: ' + text), ()=> { prompt('Copiar manualmente:', text); });
  } else { prompt('Copiar manualmente:', text); }
}

/* intersection reveal (simple) */
const io = new IntersectionObserver((entries)=> {
  entries.forEach(e=>{
    if(e.isIntersecting) e.target.style.opacity = 1;
  });
},{threshold:0.08});
document.querySelectorAll('.skin-card, .server-box, .discord-box, .glass').forEach(el=> { el.style.opacity = 0; io.observe(el); });

/* add year */
document.getElementById('year').textContent = new Date().getFullYear();

/* ========= SFTP NOTE =========
   You provided: sftp://node-va5.holy.gg:2022
   - Browsers cannot use SFTP directly.
   - Use this SFTP URL (with username/password or SSH key) in your SFTP client (FileZilla, WinSCP, scp, rsync).
   - Upload images, additional assets or enable CORS on your hosting if you want APIs to be accessible server-side.
   - Example (terminal): `sftp -P 2022 user@node-va5.holy.gg` then `put your_asset.png`
   - Once assets are uploaded to the server, reference them with HTTPS URLs in this page.
   ============================ */

</script>
</body>
</html>
